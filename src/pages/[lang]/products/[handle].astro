---
import Layout from '@layouts/Layoutp.astro';
import { getTranslatedProductByHandle } from '@libs/shopify';
import AddToCart from '@themes/default/components/AddToCart';
import SizeChart from '@components/SizeChart.astro';
import Reviews from '@components/Reviews.astro';
import ProductFAQ from '@components/ProductFAQ.astro';
import { ChevronLeft, ChevronRight, Info } from 'lucide-react';
import ProductCard from '@themes/default/components/ProductCard';
import BaseHead from '@themes/default/components/BaseHead.astro';
import ProductSpecs from '@components/ProductSpecs.astro';
import KeyFeatures from '@components/KeyFeatures.astro';
import ProductLoading from '@components/ProductLoading.astro';

const { lang, handle } = Astro.params;
const supportedLanguages = ['en', 'fr', 'de', 'es', 'it'];
let product;
let relatedProducts;
let error;

console.log(`ðŸ” Fetching product: ${handle} in language: ${lang}`);

try {
  const { product: translatedProduct, relatedProducts: translatedRelated } = 
    await getTranslatedProductByHandle(handle, lang);
    
  if (!translatedProduct) {
    console.error(`âŒ No product found for ${handle} in ${lang}`);
    error = `Product not available in ${lang}`;
  } else {
    console.log(`âœ… Successfully fetched ${lang} version`);
    product = translatedProduct;
    relatedProducts = translatedRelated;
  }

  if (!product) {
    error = 'Product not found';
    console.error(`âŒ Product not found: ${handle}`);
    return new Response(null, {
      status: 404,
      statusText: 'Product not found'
    });
  }

  // Validate and process product data
  const images = product?.images?.edges?.map(edge => edge.node) || [];
  const variants = product?.variants?.edges?.map(edge => ({
    ...edge.node,
    availableForSale: true
  })) || [];
  const options = product?.options || [];

  // Detailed validation with specific error messages
  if (images.length === 0) {
    console.error(`âŒ No images found for product: ${handle}`);
    error = 'Product images not available';
  }
  
  if (variants.length === 0) {
    console.error(`âŒ No variants available for product: ${handle}`);
    console.log('Product data:', JSON.stringify(product, null, 2));
    error = 'Product variants not available';
  }

  if (error) {
    return new Response(null, {
      status: 404,
      statusText: error
    });
  }

  // Assign processed data back to product for template use
  product.processedImages = images;
  product.processedVariants = variants;
  product.processedOptions = options;

} catch (e) {
  console.error(`âŒ Error processing product:`, {
    handle,
    language: lang,
    error: e.message,
    stack: e.stack,
    productData: product
  });
  
  return new Response(null, {
    status: 404,
    statusText: `Failed to process product: ${e.message}`
  });
}

// Final validation before rendering
if (!product || !product.processedImages || !product.processedVariants) {
  console.error(`âŒ Invalid processed data structure:`, { 
    product,
    hasImages: !!product?.processedImages,
    hasVariants: !!product?.processedVariants
  });
  return new Response(null, {
    status: 404,
    statusText: 'Invalid processed data'
  });
}

// Generate structured data for the product
const productSchema = {
  "@context": "https://schema.org/",
  "@type": "Product",
  "name": product.title,
  "description": product.description,
  "image": product.processedImages.map(img => img.url),
  "sku": product.id,
  "offers": product.processedVariants.map(variant => ({
    "@type": "Offer",
    "price": variant.price.amount,
    "priceCurrency": variant.price.currencyCode,
    "availability": variant.availableForSale 
      ? "https://schema.org/InStock" 
      : "https://schema.org/OutOfStock"
  })),
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": "4.7",
    "reviewCount": "3"
  },
  "review": [
    {
      "@type": "Review",
      "author": "Sarah M.",
      "datePublished": "2024-02-15",
      "reviewRating": {
        "@type": "Rating",
        "ratingValue": "5"
      }
    }
  ]
};

// Generate breadcrumb schema
const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": `${Astro.url.origin}/${lang}`
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Products",
      "item": `${Astro.url.origin}/${lang}/products`
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": product.title,
      "item": Astro.url.href
    }
  ]
};

// Generate alternate language URLs
const alternateUrls = supportedLanguages.map(l => ({
  lang: l,
  url: `${Astro.url.origin}/${l}/products/${handle}`
}));

// Meta description optimization
const metaDescription = `Buy ${product.title} - ${
  product.description
    .slice(0, 150)
    .replace(/[^\w\s-]/g, '')
    .trim()
}...`;

// Process the product data before passing to components
const processProductData = (rawProduct) => {
  // Ensure variants are properly structured
  const processedVariants = rawProduct.variants.edges.map(edge => ({
    ...edge.node,
    selectedOptions: edge.node.selectedOptions,
    image: edge.node.image ? {
      id: edge.node.image.id,
      altText: edge.node.image.altText
    } : null
  }));

  // Ensure images are properly structured
  const processedImages = rawProduct.images.edges.map(edge => ({
    id: edge.node.id,
    url: edge.node.url,
    altText: edge.node.altText || rawProduct.title
  }));

  return {
    id: rawProduct.id,
    title: rawProduct.title,
    variants: processedVariants,
    options: rawProduct.options,
    image: processedImages[0]?.url,
    images: processedImages,
  };
};

// Process the product data
const processedProduct = product ? processProductData(product) : null;

// Debug logging
console.log('Processed product data:', {
  variants: processedProduct?.variants.length,
  images: processedProduct?.images.length,
  options: processedProduct?.options
});

---

<!DOCTYPE html>
<html lang={lang}>
  <head>
    <BaseHead 
      title={product.seo?.title || `${product.title} | RidWear`}
      description={product.seo?.description || metaDescription}
      image={product.processedImages[0].url}
      article={false}
    />
    
    <!-- Resource Hints -->
    <link rel="preconnect" href="https://cdn.shopify.com" />
    <link rel="dns-prefetch" href="https://cdn.shopify.com" />
    
    <!-- Preload critical assets -->
    <link 
      rel="preload" 
      as="image" 
      href={product.processedImages[0].url}
      fetchpriority="high"
    />
    
    <!-- Preload critical fonts -->
    <link
      rel="preload"
      href="/fonts/inter-var.woff2"
      as="font"
      type="font/woff2"
      crossorigin
    />
    
    <!-- Defer non-critical CSS -->
    <link 
      rel="stylesheet" 
      href="/styles/non-critical.css"
      media="print" 
      onload="this.media='all'"
    />
    
    <!-- Additional SEO Meta Tags -->
    <meta name="robots" content="index, follow" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    
    <!-- Open Graph Product Specific -->
    <meta property="og:price:amount" content={product.processedVariants[0].price.amount} />
    <meta property="og:price:currency" content={product.processedVariants[0].price.currencyCode} />
    <meta property="product:availability" content={product.processedVariants[0].availableForSale ? "in stock" : "out of stock"} />
    
    <!-- Language variants -->
    {alternateUrls.map(({ lang, url }) => (
      <link rel="alternate" hreflang={lang} href={url} />
    ))}
    <link rel="alternate" hreflang="x-default" href={`${Astro.url.origin}/en/products/${handle}`} />
    
    <!-- Additional Schema Markup -->
    <script type="application/ld+json" set:html={JSON.stringify(productSchema)} />
    <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />
    
    <!-- Mobile Optimization -->
    <link rel="preload" as="image" href={product.processedImages[0].url} />
    {product.processedImages.slice(1).map(img => (
      <link rel="prefetch" as="image" href={img.url} />
    ))}
    
    <!-- PWA Tags -->
    <meta name="theme-color" content="#ffffff" />
    <link rel="manifest" href="/manifest.json" />
  </head>
  <body>
    <Layout title={`${product.title} | RidWear`}>
      <div id="product-wrapper" class="relative">
        <div 
          id="product-content" 
          class="opacity-100 transition-opacity duration-300"
          data-handle={handle}
        >
          <!-- Breadcrumb Navigation -->
          <nav aria-label="Breadcrumb" class="max-w-7xl mx-auto px-4 py-4">
            <ol class="flex items-center space-x-2 text-sm text-gray-600">
              <li>
                <a href={`/${lang}`} class="hover:text-blue-600">Home</a>
              </li>
              <li>
                <span class="mx-2">/</span>
                <a href={`/${lang}/products`} class="hover:text-blue-600">Products</a>
              </li>
              <li>
                <span class="mx-2">/</span>
                <span class="text-gray-900">{product.title}</span>
              </li>
            </ol>
          </nav>

          <main class="max-w-7xl mx-auto px-4 py-12">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
              <!-- Image Gallery -->
              <div class="space-y-4 lg:sticky lg:top-24 lg:self-start">
                <div class="relative bg-gray-50 rounded-2xl overflow-hidden">
                  <div class="aspect-square">
                    <img
                      id="mainImage"
                      src={product.processedImages[0].url}
                      alt={product.processedImages[0].altText}
                      class="w-full h-full object-contain transition-opacity duration-200"
                      loading="eager"
                      fetchpriority="high"
                      decoding="async"
                      width="600"
                      height="600"
                    />
                  </div>
                  
                  {product.processedImages.length > 1 && (
                    <div class="flex gap-2 overflow-x-auto pb-2 mt-4">
                      {product.processedImages.map((image, index) => (
                        <button 
                          class:list={[
                            "flex-none w-20 aspect-square rounded-lg overflow-hidden bg-gray-50 hover:opacity-75 transition-opacity",
                            { "ring-2 ring-blue-500": index === 0 }
                          ]}
                          data-image-url={image.url}
                          data-image-id={image.id}
                          data-image-index={index}
                        >
                          <img
                            src={image.url}
                            alt={image.altText}
                            class="w-full h-full object-cover"
                            loading="lazy"
                            decoding="async"
                            width="80"
                            height="80"
                          />
                        </button>
                      ))}
                    </div>
                  )}
                </div>
              </div>

              <!-- Product Info -->
              <div class="space-y-8 relative" style="z-index: 50;">
                <div>
                  <h1 class="text-3xl font-bold mb-2">{product.title}</h1>
                  <div class="flex items-center gap-2 text-sm text-gray-600">
                    <div class="flex items-center">
                      â˜…â˜…â˜…â˜…â˜†
                      <span class="ml-1">4.0</span>
                    </div>
                    <span>â€¢</span>
                    <a href="#reviews" class="hover:text-blue-500">42 Reviews</a>
                  </div>
                </div>

                <AddToCart
                  client:load
                  product={processedProduct}
                  language={lang}
                />

                <!-- Add debug output in development -->
                {import.meta.env.DEV && (
                  <script define:vars={{ debug: processedProduct }}>
                    console.log('Product data passed to AddToCart:', debug);
                  </script>
                )}

                <!-- Product Description - Optimized for Dynamic Content -->
                <div class="bg-gradient-to-br from-gray-50 to-white rounded-xl p-6 shadow-sm">
                  <h2 class="text-2xl font-bold mb-4 text-gray-900 flex items-center gap-2">
                    <Info className="w-6 h-6 text-blue-600" />
                    Product Details
                  </h2>
                  <div 
                    set:html={product.descriptionHtml} 
                    class="
                      text-gray-700 
                      [&>p]:mb-6 
                      [&>p]:leading-relaxed 
                      [&>p]:text-base

                      [&>h2]:text-xl 
                      [&>h2]:font-bold 
                      [&>h2]:text-gray-900 
                      [&>h2]:mt-10 
                      [&>h2]:mb-6
                      [&>h2]:pb-2
                      [&>h2]:border-b
                      [&>h2]:border-gray-200

                      [&>h3]:text-xl 
                      [&>h3]:font-semibold 
                      [&>h3]:text-gray-800 
                      [&>h3]:mt-8 
                      [&>h3]:mb-4
                      [&>h3]:flex
                      [&>h3]:items-center
                      [&>h3]:gap-2

                      [&>h4]:text-lg 
                      [&>h4]:font-semibold 
                      [&>h4]:text-gray-800 
                      [&>h4]:mt-6 
                      [&>h4]:mb-3

                      [&>ul]:list-disc 
                      [&>ul]:ml-6 
                      [&>ul]:mb-6 
                      [&>ul>li]:mb-2
                      [&>ul>li]:text-gray-700

                      [&>ol]:list-decimal 
                      [&>ol]:ml-6 
                      [&>ol]:mb-6 
                      [&>ol>li]:mb-2
                      [&>ol>li]:text-gray-700

                      [&>strong]:font-bold
                      [&>strong]:text-gray-900

                      [&>em]:italic
                      
                      [&>a]:text-blue-600 
                      [&>a]:underline 
                      [&>a]:font-medium
                      [&>a:hover]:text-blue-800

                      [&>blockquote]:pl-4 
                      [&>blockquote]:border-l-4 
                      [&>blockquote]:border-gray-200 
                      [&>blockquote]:italic
                      [&>blockquote]:text-gray-600
                      [&>blockquote]:my-6

                      [&>img]:rounded-lg
                      [&>img]:shadow-md
                      [&>img]:my-4

                      [&>table]:w-full
                      [&>table]:border-collapse
                      [&>table]:mb-6
                      [&>table]:bg-white
                      [&>table]:shadow-sm
                      [&>table]:rounded-lg
                      [&>table]:overflow-hidden
                      [&>table]:border
                      [&>table]:border-gray-200

                      [&>table>thead]:bg-gray-50
                      [&>table>thead>tr]:border-b
                      [&>table>thead>tr]:border-gray-200

                      [&>table>thead>tr>th]:px-6
                      [&>table>thead>tr>th]:py-3
                      [&>table>thead>tr>th]:text-left
                      [&>table>thead>tr>th]:font-semibold
                      [&>table>thead>tr>th]:text-gray-900
                      [&>table>thead>tr>th]:text-sm
                      [&>table>thead>tr>th]:uppercase
                      [&>table>thead>tr>th]:tracking-wider

                      [&>table>tbody>tr]:border-b
                      [&>table>tbody>tr]:border-gray-200
                      [&>table>tbody>tr]:last:border-b-0
                      [&>table>tbody>tr:hover]:bg-gray-50

                      [&>table>tbody>tr>td]:px-6
                      [&>table>tbody>tr>td]:py-4
                      [&>table>tbody>tr>td]:text-sm
                      [&>table>tbody>tr>td]:text-gray-700
                      [&>table>tbody>tr>td]:whitespace-normal

                      [&>table>tbody>tr>td:first-child]:font-medium
                      [&>table>tbody>tr>td:first-child]:text-gray-900

                      [&>table>tfoot]:bg-gray-50
                      [&>table>tfoot>tr]:border-t
                      [&>table>tfoot>tr]:border-gray-200
                      [&>table>tfoot>tr>td]:px-6
                      [&>table>tfoot>tr>td]:py-3
                      [&>table>tfoot>tr>td]:text-sm
                      [&>table>tfoot>tr>td]:font-semibold

                      [&>*:first-child]:mt-0
                      [&>*:last-child]:mb-0
                    "
                  />
                </div>

                <!-- Key Features List -->
                <KeyFeatures productTitle={product.title} language={lang} />

                <!-- Product Specifications -->
                <ProductSpecs productTitle={product.title} language={lang} />

                <!-- Size Chart Component -->
                <SizeChart productTitle={product.title} language={lang} />

                <!-- Reviews Component -->
                <Reviews language={lang} />

                <!-- Product FAQ Component -->
                <ProductFAQ productTitle={product.title} language={lang} />
              </div>
            </div>

            <!-- Related Products -->
            <div class="mt-16 border-t pt-16">
              <h2 class="text-2xl font-bold mb-8">Related Products</h2>
              <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                {relatedProducts.map((product) => (
                  <ProductCard
                    client:load
                    id={product.node.id}
                    title={product.node.title}
                    price={parseFloat(product.node.priceRange.minVariantPrice.amount)}
                    image={product.node.images.edges[0]?.node.url}
                    description={product.node.description}
                    handle={product.node.handle}
                    lang={lang}
                  />
                ))}
              </div>
            </div>
          </main>
        </div>
        
        <div 
          id="loading-skeleton" 
          class="hidden"
          aria-hidden="true"
        >
          <ProductLoading />
        </div>
      </div>
      
      <script>
        class ProductPageManager {
          constructor() {
            this.content = document.getElementById('product-content');
            this.loading = document.getElementById('loading-skeleton');
            this.currentPath = window.location.pathname;
            this.isTransitioning = false;
            this.init();
          }

          init() {
            // Force content visible and loading hidden on init
            if (this.content && this.loading) {
              this.content.style.opacity = '1';
              this.content.style.display = 'block';
              this.loading.style.display = 'none';
            }

            // Only handle actual page navigation
            document.addEventListener('astro:before-preparation', (event) => {
              if (!event.to?.url) return;
              
              const newPath = new URL(event.to.url).pathname;
              if (newPath === this.currentPath) return;
              
              // Only show loading for product page navigation
              if (newPath.includes('/products/') && !this.isTransitioning) {
                this.isTransitioning = true;
                this.handleNavigation();
              }
            });

            // Reset after navigation
            document.addEventListener('astro:after-preparation', () => {
              if (this.isTransitioning) {
                this.isTransitioning = false;
                this.currentPath = window.location.pathname;
                this.showContent();
              }
            });

            // Prevent any scroll-based transitions
            window.addEventListener('scroll', (e) => {
              e.stopPropagation();
            }, { passive: true });

            // Clean up scroll listeners
            const cleanup = () => {
              window.removeEventListener('scroll', this.handleScroll);
            };
            document.addEventListener('astro:unmount', cleanup);
          }

          handleNavigation() {
            if (!this.isTransitioning) return;
            
            // Save scroll position
            sessionStorage.setItem('scrollPosition', window.scrollY.toString());
            
            this.content.style.opacity = '0';
            this.content.style.pointerEvents = 'none';
            
            requestAnimationFrame(() => {
              this.loading.style.display = 'block';
              this.loading.style.opacity = '1';
            });
          }

          showContent() {
            if (!this.content || !this.loading) return;
            
            this.loading.style.opacity = '0';
            this.loading.style.display = 'none';
            
            requestAnimationFrame(() => {
              this.content.style.opacity = '1';
              this.content.style.pointerEvents = 'auto';
              
              // Restore scroll position if exists
              const savedPosition = sessionStorage.getItem('scrollPosition');
              if (savedPosition) {
                window.scrollTo(0, parseInt(savedPosition));
                sessionStorage.removeItem('scrollPosition');
              }
            });
          }
        }

        // Initialize only once
        let pageManager;
        if (!window.productPageManager) {
          window.productPageManager = new ProductPageManager();
        }
      </script>
    </Layout>
  </body>
</html>

<script>
  class ImageGallery {
    mainImage;
    thumbnails;
    currentIndex = 0;

    constructor() {
      this.init();
    }

    init() {
      // Get elements
      this.mainImage = document.getElementById('mainImage');
      this.thumbnails = document.querySelectorAll('[data-image-url]');
      
      // Add click handlers
      this.thumbnails.forEach((thumb, index) => {
        thumb.addEventListener('click', () => this.setImage(index));
      });

      // Listen for variant changes
      window.addEventListener('variantImageChange', (event) => {
        const { imageUrl, imageId } = event.detail;
        const matchingThumb = Array.from(this.thumbnails)
          .find(thumb => thumb.dataset.imageId === imageId);

        if (matchingThumb) {
          const index = parseInt(matchingThumb.dataset.imageIndex);
          this.setImage(index);
        } else if (imageUrl && this.mainImage) {
          this.mainImage.src = imageUrl;
        }
      });
    }

    setImage(index) {
      if (!this.mainImage) return;
      
      // Update current index
      this.currentIndex = index;
      
      // Update main image
      const newUrl = this.thumbnails[index].dataset.imageUrl;
      if (newUrl) {
        this.mainImage.src = newUrl;
      }

      // Update thumbnail states
      this.thumbnails.forEach((thumb, i) => {
        thumb.classList.toggle('ring-2', i === index);
        thumb.classList.toggle('ring-blue-500', i === index);
      });
    }
  }

  // Initialize
  new ImageGallery();
</script>

<style>
  /* Add this to your global CSS or in the page */
  .floating-buttons {
    z-index: 40; /* Make sure this is lower than the product info section */
  }
</style>

<div class="fixed right-4 top-1/2 transform -translate-y-1/2 space-y-4 floating-buttons">
  <!-- Your floating buttons here -->
</div>

<style is:inline>
  /* Critical CSS */
  .aspect-square {
    aspect-ratio: 1 / 1;
  }
  .object-contain {
    object-fit: contain;
  }
  .rounded-2xl {
    border-radius: 1rem;
  }
  /* Add other critical styles */
</style>

<style>
  #product-wrapper {
    min-height: 100vh;
    isolation: isolate;
  }
  
  #loading-skeleton {
    position: fixed;
    inset: 0;
    z-index: 100;
    background: white;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease-in-out;
  }
  
  #product-content {
    position: relative;
    z-index: 1;
    transition: opacity 0.3s ease-in-out;
  }

  /* Prevent any transition triggers from scroll */
  html, body {
    scroll-behavior: smooth;
    overscroll-behavior: none;
  }
</style>